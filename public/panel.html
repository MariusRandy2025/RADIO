<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>⚙️ Panel de Configuración - Radio</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
</head>
<body>
  <h1>⚙️ Panel de Configuración</h1>
  <p>Bienvenido, <span id="user"></span></p>

  <section>
    <h2>🔑 Cambiar contraseña</h2>
    <form id="changePasswordForm" class="form">
      <input type="password" id="oldPass" placeholder="Contraseña actual" required><br>
      <input type="password" id="newPass" placeholder="Nueva contraseña" required minlength="6"><br>
      <button type="submit" class="btn">
        <i class="fa-solid fa-key"></i> Cambiar
      </button>
    </form>
  </section>

  <section>
    <h2>👥 Gestión de locutores</h2>
    <form id="newUserForm" class="form">
      <input type="text" id="newUser" placeholder="Nuevo usuario" required><br>
      <input type="password" id="newUserPass" placeholder="Contraseña" required minlength="6"><br>
      <button type="submit" class="btn">
        <i class="fa-solid fa-user-plus"></i> Crear locutor
      </button>
    </form>

    <h3>🗑️ Eliminar locutor</h3>
    <form id="deleteUserForm" class="form">
      <input type="text" id="delUser" placeholder="Usuario a eliminar" required><br>
      <button type="submit" class="btn danger">
        <i class="fa-solid fa-user-minus"></i> Eliminar
      </button>
    </form>
  </section>

  <div style="margin-top:20px;">
    <a href="/admin" class="btn"><i class="fa-solid fa-arrow-left"></i> Volver a transmisión</a>
    <a href="/logout" class="btn"><i class="fa-solid fa-door-closed"></i> Cerrar sesión</a>
  </div>

  <script>
    // === Obtener nombre del usuario conectado ===
    async function getUser() {
      try {
        const res = await fetch('/api/whoami');
        if (!res.ok) return location.href = '/login.html';
        const data = await res.json();
        document.getElementById('user').textContent = data.username;
        window.username = data.username;
      } catch {
        location.href = '/login.html';
      }
    }
    getUser();

    // === Cambiar contraseña ===
    document.getElementById('changePasswordForm').onsubmit = async e => {
      e.preventDefault();
      const oldPass = oldPass.value.trim();
      const newPass = newPass.value.trim();
      if (newPass.length < 6) return alert("La nueva contraseña debe tener al menos 6 caracteres.");
      const res = await fetch('/api/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ oldPass, newPass })
      });
      alert(await res.text());
      e.target.reset();
    };

    // === Crear locutor ===
    document.getElementById('newUserForm').onsubmit = async e => {
      e.preventDefault();
      const username = newUser.value.trim();
      const password = newUserPass.value.trim();
      if (password.length < 6) return alert("La contraseña debe tener al menos 6 caracteres.");
      const res = await fetch('/api/new-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      alert(await res.text());
      e.target.reset();
    };

    // === Eliminar locutor ===
    document.getElementById('deleteUserForm').onsubmit = async e => {
      e.preventDefault();
      const username = delUser.value.trim();
      if (!confirm(`¿Seguro que quieres eliminar a "${username}"?`)) return;
      const res = await fetch('/api/delete-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      });
      alert(await res.text());
      e.target.reset();
    };
  </script>
</body>
</html>

